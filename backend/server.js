const express = require('express');
const app = express();
const port = 3000;
const database = require('./database');  //ì™¸ë¶€ì—ì„œ ì •ì˜ëœíŒŒì¼ì„ ë¶ˆëŸ¬ë“¤ì¼ ë•Œ requrie()ì‚¬ìš©
//**database.jsíŒŒì¼ì„ ë“¤ì—¬ì™€ì„œ ì •ì˜ëœ í•¨ìˆ˜ë¥¼ database.run()ìœ¼ë¡œ ì‚¬ìš©í•¨.

app.use(express.json()); // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë„˜ì˜¤ì˜¨ JSON ë°ì´í„°ë¥¼ JavaScript ê°ì²´ë¡œ ë³€í™˜

const memos=["ì„œë²„ì˜ ë©”ëª¨-1", "ì„œë²„ì˜ ë©”ëª¨-2", "ì„œë²„ì˜ ë©”ëª¨-3"];  //ë””ë¹„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©í–ˆì„ ë•Œ í•„ìš”í•œ ìž„ì‹œì €ìž¥ê³µê°„


//ì•„ëž˜ì—ì„œ res.send(result);ë¥¼ í•œ ì´ìœ ëŠ” ìž‘ì—…í•œ ì´í›„ë¡œ ìƒˆë¡œ ì¡°íšŒë¥¼ í•˜ì—¬ í…Œì´ë¸” ì „ì²´ì˜ ë‚´ìš©ì„ ë‹¤ì‹œ ë³´ë‚¸ë‹¤.
app.get('/api/memos', async (req, res) => {     // ë¹„ë™ê¸° í•¨ìˆ˜ `app.get` ë‚´ë¶€ì—ì„œ ë¹„ë™ê¸° ìž‘ì—…ì„ ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `async`ë¥¼ ì‚¬ìš©
    const result = await database.run("SELECT * FROM memodata");    // `database.run()`ì€ ë¹„ë™ê¸° í•¨ìˆ˜ì´ë©°, `await`ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    res.send(result);  // ë°ì´í„° ì¡°íšŒê°€ ì™„ë£Œëœ í›„ í´ë¼ì´ì–¸íŠ¸ì— ê²°ê³¼ë¥¼ ì‘ë‹µìœ¼ë¡œ ì „ì†¡
});

app.post('/api/memos', async(req, res) => {
    await database.run(`insert into memodata (content) values ('?')`, [req.body.contentData]);   //?ë¡œ ì²˜ë¦¬í•˜ì—¬ []ë°°ì—´í˜•íƒœë¡œ ê°’ì„ ë„˜ê²¨ì£¼ë©´ í•´ì»¤ì˜ ì¿¼ë¦¬ì¡°ìž‘ê³µê²©ì— ì•ˆì „í•  ìˆ˜ ìžˆë‹¤.
    const result=await database.run("SELECT * FROM memodata");
    res.send(result);  // ì¶”ê°€ëœ ë©”ì„¸ì§€ë¥¼ ì‘ë‹µìœ¼ë¡œ ì „ì†¡
    
});  

app.put('/api/edit', async (req, res) => {   // `async` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸° í•¨ìˆ˜ë¡œ ì„ ì–¸ â†’ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ `await`ì„ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ í•¨
    await database.run(`UPDATE memodata SET content=? WHERE id=?`, [req.body.contentData, req.body.indexData] );  //ê°’ì„ 2ê°œë¡œ ë°°ì—´í˜•íƒœë¡œ ë„˜ê¹€
     // `await`ì„ ì‚¬ìš©í•˜ì—¬ update ì¿¼ë¦¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ â†’ updateê°€ ëë‚˜ê¸° ì „ì— ë‹¤ìŒ ì½”ë“œê°€ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ í•¨ (ìˆœì„œ ë³´ìž¥)
    const result = await database.run("SELECT * FROM memodata");
    // updateê°€ ì™„ë£Œëœ í›„ì— select ì‹¤í–‰  â†’ `await`ì„ ì‚¬ìš©í•˜ì—¬ ìµœì‹  ë°ì´í„°ê°€ ì¡°íšŒë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼,  ì¡°íšŒëœ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜ë¨)
    console.log("resultê²°ê³¼:", result);  
    res.send(result);   // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ìµœì‹  ë°ì´í„° ì‘ë‹µ ì „ì†¡
});

// ë¹„ë™ê¸° í•¨ìˆ˜ëŠ” ë°”ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šê³ , ë‚˜ì¤‘ì— ê²°ê³¼ë¥¼ ê°€ì ¸ì˜´ â†’ ê·¸ëž˜ì„œ Promise ê°ì²´ë¥¼ ë°˜í™˜í•¨
// Promise ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ëŠ” ìš°ë¦¬ê°€ ì˜ˆìƒí•œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
// ì´ê±¸ ë™ê¸°ì ìœ¼ë¡œ(ìˆœì„œëŒ€ë¡œ) ì‹¤í–‰í•˜ë ¤ë©´?
// âœ… awaitì„ ë¶™ì´ë©´ â†’ ê·¸ í•¨ìˆ˜ê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì‹¤í–‰
// âœ… then()ì„ ì“°ë©´ â†’ Promiseì˜ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ì‹¤í–‰
// ðŸ‘‰ ê·¸ëž˜ì„œ Promise + await(or then()) ì¡°í•©ì„ ì‚¬ìš©í•˜ë©´ ë¹„ë™ê¸° ì½”ë“œë„ ë™ê¸°ì ì¸ íë¦„ì²˜ëŸ¼ ì§¤ ìˆ˜ ìžˆë‹¤! ðŸš€

//ë””ë¹„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œ getë°©ì‹
// app.get('/api/memos', (req, res) => {
//  res.send(memos);
// });

//ë””ë¹„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œ postë°©ì‹
// app.post('/api/memos', (req, res) => {
//     const newMemo = req.body.message;
//     memos.push(newMemo);  // ì „ì†¡ëœ ë©”ì„¸ì§€ë¥¼ memos ë°°ì—´ì— ì¶”ê°€
//     res.send(newMemo+"ë¡œ ë³´ë‚´ì‹  ë©”ì„¸ì§€ê°€ ì„œë²„ì— ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");    // ì¶”ê°€ëœ ë©”ì„¸ì§€ë¥¼ ì‘ë‹µìœ¼ë¡œ ì „ì†¡
// });

//ë””ë¹„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œ putë°©ì‹
// app.put('/api/edit', (req, res) => {
//     memos[req.body.indexData] = req.body.contentMessage;   //ì´ë°©ì‹ì´ ì•„ëž˜ê²ƒ ë³´ë‹¤ ë” ê°„ë‹¨í•˜ë‹¤.
//    // memos.splice(req.body.indexData,1, req.body.contentMessage);   //splice(ì‹œìž‘ìœ„ì¹˜, ì‚­ì œí•  ìš”ì†Œ ê°¯ìˆ˜, ì¶”ê°€í•  ìš”ì†Œ)
//     res.send(memos+": ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
// });

app.listen(port, () => {
    console.log(`âœ… ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${port}`);
});
